<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Config 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cafe24.kangk0269.dao.BidPlantMapper">
	<resultMap type="BidPlantDTO" id="BidPlantDTOMap">
		<id		property="bPlCode" 				column="b_pl_code" />
		<result property="mId" 					column="sell_id" />
		<result property="bPlTitle" 			column="b_pl_title" />
		<result property="bzPlCode" 			column="bz_pl_code" />
		<result property="bPlContents"			column="b_pl_contents" />		
		<result property="bPlPrice" 			column="b_pl_price" />	
		<result property="plDepDataResidual" 	column="pl_dep_data_residual" />	
		<result property="plDepPrice" 			column="pl_dep_price" />	
		<result property="plDepStartDate" 		column="pl_dep_start_date" />	
		<result property="bPlStatus" 			column="b_pl_status" />	
		<result property="bPlDateRequest" 		column="b_pl_date_request" />	
		<result property="bPlDateBidding1" 		column="b_pl_date_bidding1" />	
		<result property="bPlDateBidding2" 		column="b_pl_date_bidding2" />	
		<result property="bPlDateDecision1" 	column="b_pl_date_decision1" />	
		<result property="bPlDateDecision2" 	column="b_pl_date_decision2" />	
		<result property="bPlGroupcode" 		column="b_pl_groupcode" />	
		<result property="bPlReCount" 			column="b_pl_re_count" />	
		<result property="bPlConfirm" 			column="b_pl_confirm" />	
		<result property="bPlConfirmStatus" 	column="b_pl_confirm_status" />	
		<result property="bPlRejectReason" 		column="b_pl_reject_reason" />	
		<result property="bPlCancelReason" 		column="b_pl_cancel_reason" />	
		<result property="bPlCancelDate" 		column="b_pl_cancel_date" />	
		<result property="acStatusCode" 		column="ac_status_code" />
		<collection property="bidListDTO" 		resultMap="bidListDTOMap" />
		
		<collection property="bidListDTOList" 		ofType="bidListDTO">
    		<id 	property="bCode" 				column="b_code"/>
			<result property="announcedCode" 		column="announced_code" />
			<result property="bTypeCode" 			column="b_type_code" />
			<result property="mId"					column="buy_id" />
			<result property="bPrice" 				column="b_price" />
			<result property="sDepositRate" 		column="s_dep_rate" />
			<result property="bDeposit" 			column="b_deposit" />
			<result property="bDepositCheck" 		column="b_deposit_check" />
			<result property="bMoCode" 				column="b_mo_code" />
			<result property="bDepositDate" 		column="b_deposit_date" />
			<result property="trTypeCode" 			column="tr_type_code" />
			<result property="trTypeName" 			column="tr_type_name" />
			<result property="dcInstructions" 		column="dc_instructions" />
			<result property="dcApplication" 		column="dc_application" />
			<result property="dcProposal" 			column="dc_proposal" />
			<result property="bDate" 				column="b_date" />
			<result property="bCheck" 				column="b_check" />
			<result property="bRank" 				column="b_rank" />
			<result property="bDepositAvailable" 	column="b_deposit_available" />
			<result property="bDepositRefund" 		column="b_deposit_refund" />
			<result property="bDateUp" 				column="b_date_up" />
   		</collection>
	</resultMap>
	<resultMap type="BidListDTO" id="bidListDTOMap">
		<id 	property="bCode" 				column="b_code"/>
		<result property="announcedCode" 		column="announced_code" />
		<result property="bTypeCode" 			column="b_type_code" />
		<result property="mId"					column="buy_id" />
		<result property="bPrice" 				column="b_price" />
		<result property="bTitle" 				column="b_title" />
		<result property="sDepositRate" 		column="s_dep_rate" />
		<result property="bDeposit" 			column="b_deposit" />
		<result property="bDepositCheck" 		column="b_deposit_check" />
		<result property="bMoCode" 				column="b_mo_code" />
		<result property="bDepositDate" 		column="b_deposit_date" />
		<result property="trTypeCode" 			column="tr_type_code" />
		<result property="trTypeName" 			column="tr_type_name" />
		<result property="dcInstructions" 		column="dc_instructions" />
		<result property="dcApplication" 		column="dc_application" />
		<result property="dcProposal" 			column="dc_proposal" />
		<result property="bDate" 				column="b_date" />
		<result property="bCheck" 				column="b_check" />
		<result property="bRank" 				column="b_rank" />
		<result property="bDepositAvailable" 	column="b_deposit_available" />
		<result property="bDepositRefund" 		column="b_deposit_refund" />
		<result property="bDateUp" 				column="b_date_up" />
	</resultMap>
	<resultMap type="BusinessPlantDTO" id="BusinessPlantDTOMap">
		<result property="bzPlCode" 			column="bz_pl_code" />
		<result property="mId" 					column="m_id" />
		<result property="bzPlCheck" 			column="bz_pl_check" />
		<result property="bzPlName" 			column="bz_pl_name" />
		<result property="bzPlZipcode"			column="bz_pl_zipcode" />		
		<result property="bzPlAddr" 			column="bz_pl_addr" />	
		<result property="bzPlDetailAddr" 		column="bz_pl_detail_addr" />	
		<result property="bzPlPhoto" 			column="bz_pl_photo" />	
		<result property="bzPlPower" 			column="bz_pl_power" />	
		<result property="bzPlHardware" 		column="bz_pl_hardware" />	
		<result property="bzPlArea" 			column="bz_pl_area" />	
		<result property="bzPlInvPower" 		column="bz_pl_inv_power" />	
		<result property="bzPlInvCount" 		column="bz_pl_inv_count" />	
		<result property="bzPlInvMaker" 		column="bz_pl_inv_maker" />	
		<result property="bzPlRec" 				column="bz_pl_rec" />	
	</resultMap>
	<!-- 등록 발전소공고 조회(판매자아이디) -->
	<select id="getBidPlantById" resultMap="BidPlantDTOMap">
		SELECT 
			b_pl_code
			, bz_pl_code
			, m_id
			, b_pl_title
			, b_pl_contents
			, b_pl_price
			, pl_dep_data_residual
			, pl_dep_price
			, pl_dep_start_date
			, b_pl_status
			, ac_status_code
			, b_pl_number_of_bidder
			, b_pl_date_request
			, b_pl_date_bidding1
			, b_pl_date_bidding2
			, b_pl_date_decision1
			, b_pl_date_decision2
			, b_pl_groupcode
			, b_pl_re_count
			, b_pl_confirm
			, b_pl_confirm_status
			, b_pl_reject_reason
			, b_pl_cancel_reason
			, b_pl_cancel_date
		FROM 
			tb_bid_plant
			WHERE b_pl_confirm_status = 'Y' and m_id = #{mId}
	</select>
	<select id="getBidPlant" resultMap="BidPlantDTOMap" parameterType="map">
		SELECT
			b_pl_code,
			bz_pl_code, 
			m_id as sell_id, 
			b_pl_title,
			b_pl_contents, 
			b_pl_price, 
			pl_dep_data_residual, 
			pl_dep_price, 
			pl_dep_start_date, 
			b_pl_status, 
			b_pl_date_request, 
			b_pl_date_bidding1, 
			b_pl_date_bidding2, 
			b_pl_date_decision1, 
			b_pl_date_decision2, 
			b_pl_groupcode, 
			b_pl_re_count, 
			b_pl_confirm, 
			b_pl_confirm_status, 
			b_pl_reject_reason, 
			b_pl_cancel_reason, 
			b_pl_cancel_date,
			ac_status_code
		FROM 
			tb_bid_plant
		<trim prefix="where">
			<if test="status != null and status.toString() == '종료'.toString() ">		
				ac_status_code > 4						
			</if>
			<if test="status != null and status.toString() == '진행'.toString() ">		
				ac_status_code = 4						
			</if>
			<if test="searchValuePl!=null and searchKeyPl!=null">
				and ${searchKeyPl} LIKE CONCAT ('%',#{searchValuePl},'%')
			</if>
		</trim>	
		ORDER BY b_pl_date_bidding1 DESC
		<if test="bidPlantDTO!=null">
			LIMIT
				#{bidPlantDTO.pagination.firstRecordIndex},#{bidPlantDTO.recordsPerPage}
		</if>
	</select>
	<select id="getBidPlantListCount" resultType="int" parameterType="map">
		SELECT
			COUNT(1)
		FROM 
			tb_bid_plant
		<trim prefix="where">
			<if test="status != null and status.toString() == '종료'.toString() ">		
				ac_status_code > 4						
			</if>
			<if test="status != null and status.toString() == '진행'.toString() ">		
				ac_status_code = 4						
			</if>
			<if test="searchValuePl!=null and searchKeyPl!=null">
				and ${searchKeyPl} LIKE CONCAT ('%',#{searchValuePl},'%')
			</if>
		</trim>	
		ORDER BY b_pl_date_bidding1 DESC
	</select>
	<select id="getBidPlantByInfo" resultMap="BidPlantDTOMap" parameterType="String">
		SELECT
			b_pl_code,
			bz_pl_code, 
			m_id as sell_id, 
			b_pl_title,
			b_pl_contents, 
			b_pl_price, 
			pl_dep_data_residual, 
			pl_dep_price, 
			pl_dep_start_date, 
			b_pl_status, 
			b_pl_date_request, 
			b_pl_date_bidding1, 
			b_pl_date_bidding2, 
			b_pl_date_decision1, 
			b_pl_date_decision2, 
			b_pl_groupcode, 
			b_pl_re_count, 
			b_pl_confirm, 
			b_pl_confirm_status, 
			b_pl_reject_reason, 
			b_pl_cancel_reason, 
			b_pl_cancel_date,
			ac_status_code
		FROM 
			tb_bid_plant
		WHERE 
			b_pl_code = #{announceCode}
	</select>
	
	<select id="getBidPlantMyBid" resultMap="BidPlantDTOMap" parameterType="map">
		SELECT
			li.b_code,
			pl.b_pl_title,
			pl.b_pl_code,
			li.tr_type_name,
			li.b_date,
			pl.b_pl_status,
			pl.m_id as sell_id
		FROM 
			tb_bid_plant AS pl
		INNER JOIN
			tb_bid_list AS li
		ON li.announced_code = pl.b_pl_code
		<trim prefix="WHERE" prefixOverrides="AND / OR ">
			<if test="mId!=null">
				li.m_id = #{mId}
			</if>
			<if test="searchValuePl!=null and searchKeyPl!=null">
				and ${searchKeyPl} LIKE CONCAT ('%',#{searchValuePl},'%')
			</if>
		</trim>
		ORDER BY li.b_date DESC
		<if test="BidPlantDTO!=null">
			LIMIT
				#{BidPlantDTO.pagination.firstRecordIndex},#{BidPlantDTO.recordsPerPage}	
		</if>
	</select>
	<select id="getBidPlantCount" resultType="int" parameterType="map">
		SELECT
			count(1)
		FROM 
			tb_bid_plant AS pl
		INNER JOIN
			tb_bid_list AS li
		ON li.announced_code = pl.b_pl_code
		<trim prefix="WHERE" prefixOverrides="AND / OR ">
			<if test="mId!=null">
				li.m_id = #{mId}
			</if>
			<if test="searchValuePl!=null and searchKeyPl!=null">
				and ${searchKeyPl} LIKE CONCAT ('%',#{searchValuePl},'%')
			</if>
		</trim>
		ORDER BY li.b_date DESC		
	</select>
	
	<select id="getPlant" resultMap="BusinessPlantDTOMap">
		SELECT
			bp.*
		FROM
			tb_bid_plant AS pl
		INNER JOIN
			tb_business_plant AS bp
		ON 
			pl.bz_pl_code = bp.bz_pl_code
		WHERE
			pl.b_pl_code = #{announceCode}
	</select>
	<select id="getPlantSatusList" parameterType="map" resultType="String">
		SELECT
			b_pl_code
		FROM
			tb_bid_plant
		WHERE
			<if test="bStatus!=null and bStatus.toString()=='공고마감'.toString()">
				CAST(b_pl_date_bidding2 AS DATE) = CURDATE()
			</if>
			<if test="bStatus!=null and bStatus.toString()=='거래진행중'.toString()">
				CAST(b_pl_date_decision2 AS DATE) = CURDATE()
			</if>
			<if test="bStatus!=null and bStatus.toString()=='거래실패'.toString()">
				CAST(b_pl_date_decision1 AS DATE) = CURDATE()
			</if>
			AND ac_status_code = #{status};
	</select>
	<select id="getBidPlantTradeList" parameterType="String" resultMap="BidPlantDTOMap">
		SELECT
			pl.m_id AS sell_id,
			pl.*,
			bl.m_id AS buy_id,
			bl.*
		FROM
			tb_bid_plant AS pl
		JOIN
			tb_bid_list AS bl
		ON pl.b_pl_code = bl.announced_code
		WHERE
			bl.tr_type_code = 6
		AND
			bl.b_rank = 1
		AND
			bl.announced_code in
			<foreach item="item" index="index" collection="list"
		      open="(" separator="," close=")">
				 #{item}
		  	</foreach>
	</select>
	<select id="getBidPlantTradeNext" parameterType="map" resultMap="BidPlantDTOMap">
		SELECT
			pl.m_id AS sell_id,
			pl.*,
			bl.m_id AS buy_id,
			bl.*
		FROM
			tb_bid_plant AS pl
		JOIN
			tb_bid_list AS bl
		ON pl.b_pl_code = bl.announced_code
		WHERE
			bl.b_rank = #{rank}
		AND
			bl.announced_code =#{announcedCode}
	</select>
	<select id="getPlantBidList" resultType="int">
		SELECT
			COUNT(1)
		FROM
			tb_bid_list AS bl
		JOIN
			tb_bid_plant AS pl
		ON bl.announced_code = pl.b_pl_code
		WHERE
			announced_code = #{announcedCode}
			AND b_rank IS NOT null
	</select>
	<update id="updatePlantFail" parameterType="String">
		UPDATE tb_bid_plant
		SET
			b_pl_status='거래실패',
			ac_status_code=9
		WHERE 
			b_pl_code = #{announcedCode}
	</update>
</mapper>