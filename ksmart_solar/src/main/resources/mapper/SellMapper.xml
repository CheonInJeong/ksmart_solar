<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  	<mapper namespace="com.cafe24.kangk0269.dao.SellMapper">
  	
  		<resultMap type = "FileDTO" id = "fileResultMap">
  		  		<result property="relatedTableCode" column="related_table_code"/>
  		  	  	<result property="originalFileName" column="original_file_name"/>
  		  	  	<result property="storedFilePath" column="stored_file_path"/>
  		  	  	<result property="fileSize" column="file_size"/>
  				<result property="createdDatetime" column="created_datetime"/>
  		  		<result property="creatorId" column="creator_id"/>
  		</resultMap>
  		<resultMap type = "BidPlantDTO" id = "bidPlantResultMap">
  		  		<result property="bPlCode" column="b_pl_code"/>
  		  	  	<result property="bzPlCode" column="bz_pl_code"/>
  		  	  	<result property="mId" column="m_id"/>
  		  	  	<result property="bPlTitle" column="b_pl_title"/>
  				<result property="bPlContents" column="b_pl_contents"/>
  		  		<result property="bPlPrice" column="b_pl_price"/>
  		  		<result property="plDesidual" column="pl_residual"/>
  		  		<result property="plDepPrice" column="pl_dep_price"/>
  		  		<result property="plDepStartDate" column="pl_dep_start_date"/>
  		  		<result property="bPlDateRequest" column="b_pl_date_request"/>
  		  		<result property="bPlDateBidding1" column="b_pl_date_bidding1"/>
  		  		<result property="bPlDateBidding2" column="b_pl_date_bidding2"/>
  		  		<result property="bPlDateDecision1" column="b_pl_date_decision1"/>
  		  		<result property="bPlDateDecision2" column="b_pl_date_decision2"/>
  		  		<result property="bPlGroupcode" column="b_pl_groupcode"/>
  		  		<result property="bPlStatus" column="b_pl_status"/>
  		  		
  		  		<association property="businessPlantDTO" javaType="BusinessPlantDTO">
  		  			<id property="bzPlName" column="bz_pl_Name"/>
  		  			<result property="bzPlName" column="bz_pl_Name"/>
  		  		</association>
  		</resultMap>
  		
  		<resultMap type="BusinessPlantDTO" id="BusinessPlantResultMap">
  		  		<result property="bzPlCode" column="bz_pl_code"/>
  		  		<result property="mId" column="m_id"/>
  		  		<result property="bzPlCheck" column="bz_pl_check"/>
  		  		<result property="bzPlName" column="bz_pl_name"/>
  		  		<result property="bzPlZipcode" column="bz_pl_zipcode"/>
  		  		<result property="bzPlAddr" column="bz_pl_addr"/>
  		  		<result property="bzPlDetail_addr" column="bz_pl_detail_addr"/>
  		  		<result property="bzPlPhoto" column="bz_pl_photo"/>
  		  		<result property="bzPlPower" column="bz_pl_power"/>
  		  		<result property="bzPlHardware" column="bz_pl_hardware"/>
  		  		<result property="bzPlArea" column="bz_pl_area"/>
  		  		<result property="bzPlInvPower" column="bz_pl_inv_power"/>
  		  		<result property="bzPlInvCount" column="bz_pl_inv_count"/>
  		  		<result property="bzPlInvMaker" column="bz_pl_inv_maker"/>
  		  		<result property="bzPlRec" column="bz_pl_rec"/>

  		  		<association property="plantDepreciationDTO" javaType="PlantDepreciationDTO">
  		  			<id property="bzPlCode" column="bz_pl_code"/>
  		  			<result property="bzPlCode" column="bz_pl_code"/>
	  		  		<result property="plDepPrice" column="pl_dep_price"/>
	  		  		<result property="plDepStartDate" column="pl_dep_start_Date"/>
	  		  		<result property="plDepServicelife" column="pl_dep_servicelife"/>
  		  		</association>
  		  		<association property="plantDepDataDTO" javaType="PlantDepDataDTO">
  		  			<id property="bzPlCode" column="bz_pl_code"/>
  		  			<result property="bzPlCode" column="bz_pl_code"/>
  		  			<result property="plDepDataMonth" column="pl_dep_data_month"/>
	  		  		<result property="plDepDataResidual" column="pl_dep_data_residual"/>
  		  		</association>
  		  </resultMap>
  		  <resultMap type="BidListDTO" id="BidListResultMap">
  		  		<result property="bPlCode" column="b_pl_code"/>
  		  		<result property="mId" column="m_id"/>
  		  		<result property="bPlTitle" column="b_pl_title"/>
  		  		<result property="bPlContents" column="b_pl_contents"/>
  		  		<result property="bPlPrice" column="b_pl_price"/>
  		  		<result property="bPlDocument" column="b_pl_document"/>
  		  		<result property="plResidual" column="pl_residual"/>
  		  		<result property="plDepStartDate" column="pl_dep_start_date"/>
  		  		<result property="bPlCode" column="b_pl_code"/>
  		  		<result property="plDepUsed" column="pl_dep_used"/>
  		  		<result property="bPlDateRequest" column="b_pl_date_request"/>
  		  		<result property="bPlDateBidding1" column="b_pl_date_bidding1"/>
  		  		<result property="bPlDateBidding2" column="b_pl_date_bidding2"/>
  		  		<result property="bPlDateDecision1" column="b_pl_date_decision1"/>
  		  		<result property="bPlDateDecision2" column="b_pl_date_decision2"/>
  		  		<result property="bPlGroupcode" column="b_pl_groupcode"/>
  		  		<result property="bPlReCount" column="b_pl_re_count"/>
  		  		<result property="bPlConfirm" column="b_pl_confirm"/>
  		  		<result property="bPlConfirmStatus" column="b_pl_confirm_status"/>
  		  		<result property="bPlRejectReason" column="b_pl_reject_reason"/>
  		  		<result property="bPlCancelReason" column="b_pl_cancel_date"/>
  		  		<result property="bPlCancelDate" column="b_pl_cancel_date"/>
  		  		<result property="acStatusCode" column="ac_status_code"/>
  		  </resultMap>
  		  
  		  <insert id="addFile" parameterType="FileDTO">
  		  		INSERT 
  		  		INTO
  		  			 tb_file(related_table_code, original_file_name, stored_file_path, file_size, creator_id, created_datetime)
				VALUES
			<foreach collection = "list" item="item" separator=",">
					 (#{item.relatedTableCode}, #{item.originalFileName}, #{item.storedFilePath}, #{item.fileSize}, #{item.creatorId}, NOW())
			</foreach>
				
  		  </insert>
  		  
  		  <select id="getNumberOfBidder" resultType="int">
  		  		SELECT COUNT(1) FROM tb_bid_list WHERE announced_code = 'b_pl_210224_0001' AND b_deposit_check = 'Y'
  		  </select>
  		  
  		  <select id="getHighestPriceByCode" resultType="int">
  		  		SELECT max(b_price) FROM tb_bid_list WHERE announced_code = 'b_pl_210224_0001' AND b_deposit_check = 'Y'
  		  </select>
  		  <select id="getBidPlantbyId" resultMap="bidPlantResultMap" parameterType="String">
  		  		SELECT
				 	p.bz_pl_name,
					b.b_pl_title,
					b.b_pl_price,
					b.b_pl_date_bidding1,
					b.b_pl_date_bidding2,
					b.b_pl_status,
					b.b_pl_number_of_bidder
				FROM 
					tb_bid_plant AS b
				left JOIN 
					tb_business_plant AS p 
				ON 
					b.bz_pl_code = p.bz_pl_code 
				WHERE b.m_id = #{mId}
  		  </select>
  		  <!--발전소 판매 공고 신청  -->
  		  <insert id="addPlantApply" parameterType="BidPlantDTO">
				INSERT 
				INTO
					tb_bid_plant(
					b_pl_code, 
					bz_pl_code,
				 	m_id,
				  	b_pl_title,
				   	b_pl_contents, 
					b_pl_price,
					pl_dep_data_residual,
					pl_dep_price,
					pl_dep_start_date, 
					b_pl_date_request,
					b_pl_date_bidding1,
					b_pl_date_bidding2,
					b_pl_date_decision1,
					b_pl_date_decision2,
					b_pl_groupcode)
					VALUES (
					sf_b_pl_code(), 
					#{bzPlCode}, 
					#{mId}, 
					#{bPlTitle},
					#{bPlContents},
					#{bPlPrice},
					#{plDepDataResidual},
					#{plDepPrice},
					#{plDepStartDate},
					curdate(),
					#{bPlDateBidding1},
					sf_7days_after(#{bPlDateBidding1}),
					sf_7days_after(#{bPlDateBidding1}),
					sf_10days_after(#{bPlDateBidding1}),
					concat(sf_b_pl_code(),'_group'))
  		  </insert>
  		  
  		  <select id="getPlantInformation" resultMap="BusinessPlantResultMap" parameterType="String">
  		  		SELECT
					p.bz_pl_code,
					p.pl_dep_data_residual,
					d.pl_dep_start_date,
					d.pl_dep_price
	
				FROM 
					tb_plant_dep_data AS p
				inner JOIN
					tb_plant_depreciation AS d
				ON 
					p.bz_pl_code = d.bz_pl_code
				WHERE 
					p.pl_dep_data_month = d.pl_dep_servicelife 
				AND 
					p.bz_pl_code = #{bzPlCode}
  		  
  		  </select>
  		  
  		  <select id="getPlantName" resultMap="BusinessPlantResultMap" parameterType="String">
  		  		SELECT
					p.bz_pl_code,
					p.bz_pl_name 
				FROM 
					tb_bid_plant AS b 
				right JOIN
					tb_business_plant AS p 
				ON
					b.bz_pl_code = p.bz_pl_code 
				WHERE
					b.bz_pl_code IS NULL 
				AND 
					p.m_id = #{mId}

  		  </select>
		  		  
  	</mapper>