<!DOCTYPE html>
<html xmlns:th="http://www.tyhmeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="layout/default">

	<th:block layout:fragment="customTitle">
				<title>개인 정보 조회</title>
	</th:block>
	
	<th:block layout:fragment="customCss">
		<style>
			label {
				text-align:center;
			}
		</style>	
	</th:block>
	
	<th:block layout:fragment="Contents">
		<div id="container-header-title"><strong>내 정보관리</strong></div>
     	<div id="container-header-path">
     		<a href="/" style="text-decoration: none;"> 메인화면 </a>> MY PAGE > 내 정보관리
     	</div>
     	<div id="container-header-space"></div>	
		
		<div class="row mt">
          <div class="col-lg-12">
             <div class="content-panel" style="padding: 30px;">
              <h4 class="mb"><i class="fa fa-angle-right"></i>개인 정보 조회</h4>
              <form class="form-horizontal style-form">
                <div class="form-group">
					<div class="form-group">
	                  	<label class="col-sm-2 control-label">프로필 사진</label>
		               		<input type="file" id="inputFile"/>
		                  	<div class="col-md-1">
		                  		<div th:if="${session.SID ne null and memberDTO.mPhoto ne ''}" class="selectImg"><img class="img-circle" th:src="${memberDTO.mPhoto}" width="80" /></div>
		        				<p class="centered" th:if="${session.SID ne null and memberDTO.mPhoto eq null or memberDTO.mPhoto eq ''}"><img src="/img/basicMemberPicture.jpg" onerror="/img/basicMemberPicture.jpg" class="img-circle" width="40"></p>
		                  	</div>						
		                <div>  	
		                <button type="button" style="margin-left: 40px;" class="btn standardBtn" onclick="modify()">수정</button>  	
		                </div>
					</div>                
                  <label class="col-sm-2 control-label">아이디</label>
                  <div class="col-lg-10">
                    <p class="form-control-static">[[${memberDTO.mId}]]</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-sm-2 col-sm-2 control-label">이름</label>
                  <div class="col-lg-10">
                    <p class="form-control-static">[[${memberDTO.mName}]]</p>
                  </div>
                </div>
                 <div class="form-group">
                  <label class="col-lg-2 col-sm-2 control-label">연락처</label>
                  <div class="col-lg-10">
                    <p class="form-control-static">[[${memberDTO.mPhone}]]</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-lg-2 col-sm-2 control-label">이메일</label>
                  <div class="col-lg-10">
                    <p class="form-control-static">[[${memberDTO.mEmail}]]</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-sm-2 col-sm-2 control-label">우편번호</label>
                  <div class="col-lg-10">
                    <p class="form-control-static">[[${memberDTO.mZipcode}]]</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-sm-2 col-sm-2 control-label">도로명주소</label>
                  <div class="col-lg-10">
                    <p class="form-control-static">[[${memberDTO.mAddr}]]</p>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-lg-2 col-sm-2 control-label">상세주소</label>
                  <div class="col-lg-10">
                    <p class="form-control-static">[[${memberDTO.mDetailAddr}]]</p>
                  </div>
                </div>
               
                <div class="form-group">
                  <div class="col-lg-offset-2 col-lg-10">
                    <a class="btn standardBtn" th:href="@{/mypage/ModifyMyInfo}">회원정보 수정</a>
                    <a class="btn standardBtn" th:href="@{/mypage/modifyPw}">비밀번호 수정</a>
                    <a class="btn btn-danger" th:href="@{/mypage/withdraw}">회원탈퇴 신청</a>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
	</th:block>
	
	<th:block layout:fragment="customScript">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
		<script type="text/javascript">
		
			//메뉴탭
			var mypage = $('#mypage');
			mypage.addClass('active');
			mypage.parent().find('.sub').css('display','block');
			mypage.parent().find('.sub').children().eq(0).addClass('active');
			
			
			//프로필 썸네일 
			  $("#inputFile").change(function(){
			   if(this.files && this.files[0]) {
			    var reader = new FileReader;
			    reader.onload = function(data) {
			     $(".selectImg img").attr("src", data.target.result).width(150);        
			    }
			    reader.readAsDataURL(this.files[0]);
			   }
			  });
			
			//프로필 수정
			function modify(){
				//파일 업로드 ImgBB
				
				var file = document.getElementById('inputFile');
				var form = new FormData();
				var fileURL = '';
				form.append("image", file.files[0])
				
				
				var settings = {
				  "url": "https://api.imgbb.com/1/upload?key=0b3bc29eab18a6d8178b0e736b391d93",
				  "method": "POST",
				  "timeout": 0,
				  "processData": false,
				  "mimeType": "multipart/form-data",
				  "contentType": false,
				  "data": form
				};
					
					
				$.ajax(settings).done(function (response) {
					console.log(response);
					var jx = JSON.parse(response);
					fileURL = jx.data.url;	
					fileDeleteURL = jx.data.delete_url;
					$.ajax({
				        url     : '/ajax/modifyMyProfile',
				        type    : 'POST',
				        data    :   {inputFile:fileURL},
				        success : function(data) {
				        	if(data){
				        		Swal.fire({
									  title: '프로필 수정이 완료되었습니다!',
									  icon: 'success'
									});
				        		setTimeout(function(){
					        		document.location.href = '/mypage/myInfo';
				        		}, 200);
				        	}else{
				        		Swal.fire({
									  title: '프로필 수정을 실패했습니다!',
									  icon: 'error'
									});
				        		setTimeout(function(){
					        		document.location.href = '/mypage/myInfo';
				        		}, 200);
				        	}
				        },
				        error : function(xhr,status,error) {
				        	console.log("xhr: " + xhr);
				        	console.log("status: " + status);
				        	console.log("error: " + error);
				        }
				    });
				});
			}
		</script>
	</th:block>
</html>