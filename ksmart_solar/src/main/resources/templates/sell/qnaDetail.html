<!DOCTYPE html>
<html xmlns:th="http://www.tyhmeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="layout/default">

	<th:block layout:fragment="customTitle">
				<title>판매관리>문의글</title>
	</th:block>
	<th:block layout:fragment="customCss">
		<link href="/lib/fancybox/jquery.fancybox.css" rel="stylesheet" />
	</th:block>
	<th:block layout:fragment="Contents">
		<div id="container-header-title"><strong>문의글</strong></div>
		<div id="container-header-path">
			<a href="/" style="text-decoration: none;"> 메인화면 </a>>
			<a href="#" id="firstUrl" style="text-decoration: none;"> </a>>
			<a href="#" id="secondUrl" style="text-decoration: none;"> </a>>
			<a href="#" id="thirdUrl" style="text-decoration: none;"> 문의글 </a>
		</div>
		<div id="container-header-space"></div>
		<div class="row">
			<div class="col-md-12">
				<div class="content-panel" style="padding : 30px 30px 100px 30px;">
				<h4><i class="fa fa-angle-right"></i>문의글</h4>
				<hr>
				
				<div id="bIdx" style="display:none">[[${qna.bIdx}]]</div>
				<div id="bId" style="display:none">[[${qna.mIdBuyer}]]</div>
				<table class="table" id="qnaTable">
					<tbody>
						<tr>
							<td style="text-align:left">글제목</td>         			
							<td style="text-align:left" colspan="5">
								<span id="bSubject1" th:text="${qna.bSubject}"></span>
								<input type="text" id="bSubject2" name="bSubject" th:value="${qna.bSubject}" style="display: none; width: 100%;">
							</td>
						</tr>
						<tr>
							<td style="text-align:left">관련공고이름</td>
							<td th:if="${qna.bBidType==1}"style="text-align:left"><a th:href="@{/sell/bidPlantDetail(bPlCode=${qna.announcedCode})}">[[${qna.bidListDTO.bTitle}]]</a></td>
							<td th:if="${qna.bBidType==2}"style="text-align:left"><a th:href="@{/sell/getBidComponentDetail(bCpCode==${qna.announcedCode})}">[[${qna.bidListDTO.bTitle}]]</a></td>
						</tr>
						<tr>
							<td style="text-align:left">작성자</td>
							<td th:text="${qna.mIdBuyer}"></td>
							<td style="text-align:left">작성시간</td>
							<td th:text="${qna.bRegDate}"></td>
							<td style="text-align:left">조회수</td>
							<td th:text="${qna.bView}"></td>
						</tr>
						<tr>
							<td style="text-align:left;padding-left:60px;" colspan="6">
								<div style="min-height:50px; width:100%; padding-top:30px;" ><span id="bContents1" th:text="${qna.bContents}"></span></div>
							</td>
						<tr>
						<tr th:if="${qna.bPhoto!=null and qna.bPhoto!=''}">
							<td colspan="6">
								<div style="width: 100%; height: 200px;">
									<div class="photo" style="width: 100%; height: 200px;">
										<a class="fancybox" th:href="${qna.bPhoto}">
											<img class="img-responsive" alt="" th:src="${qna.bPhoto}" style="width:100%; height:100%; object-fit:contain !important;">
										</a>
									</div>
									<div class="overlay"></div>
								</div>
							</td>
						<tr>
					</tbody>
				</table>
				<hr>
				
				
				<div style="margin-top :40x;width:100%;">
						<a class="btn btn-default pull-right" style="margin: 0 5px;" id="returnBtn">목록</a>
					<th:block th:if="${qna.mIdBuyer==session.SID}">
						<form action="/sell/removeQna" method="post">
							<button class="btn btn-default pull-right" type="submit" style="margin: 0 5px;" id="qnaremoveBtn">삭제</button>
							<input type="hidden" name="bIdx" th:value="${qna.bIdx}">
							<input type="hidden" name="url" id="url">
						</form>
						<a class="btn btn-default pull-right" style="margin: 0 5px;" id="qnamodifyBtn" data-attr="0">수정</a>
					</th:block>
				</div>
				<br>
				<div>
					<h4><i class="fa fa-angle-right"></i>댓글</h4>
				</div>
				<table class="table table-striped" id="commentTable">
					<tbody>
					
						<th:block th:if="${comments!=null and comments.size()>0}" th:each="c:${comments}">
							<tr>
								<td th:text="${c.cmtIdx}" class="cmtIdx" style="display:none"></td>
								<td th:if="${c.cmtClass==0}" th:text="${c.mId}" style="font-weight: bolder"></td>
								<td th:if="${c.cmtClass>0}" th:text="${'└ '+c.mId}" style="padding-left:30px;font-weight: bolder"></td>
								<td th:if="${c.cmtClass==0 and c.cmtDeleteYn=='N'}" th:text="${c.cmtComment}" style="padding:20px; text-align:left;" class="cmtComment"></td>
								<td th:if="${c.cmtClass>0 and c.cmtDeleteYn=='N'}" th:text="${c.targetId + '｜'+c.cmtComment}" style="padding:20px; text-align:left;" class="cmtComment"></td>
								<td th:if="${c.cmtClass==0 and c.cmtDeleteYn=='Y'}" style="padding:20px; text-align:left;" class="cmtComment">삭제 된 댓글입니다.</td>
								<td th:if="${c.cmtClass>0 and c.cmtDeleteYn=='Y'}" th:text="${c.targetId + '｜'+'삭제 된 댓글입니다.'}" style="padding:20px; text-align:left;" class="cmtComment"></td>
								<td th:text="${c.cmtRegDate}"></td>
								
								<td th:if="${c.mId==session.SID and c.cmtDeleteYn=='N'}">
									<a class="btn btn-default btn-sm modifyBtn" data-attr="0">수정</a>
									<a th:href="@{/sell/removeCmt(idx=${c.cmtIdx},bIdx=${c.bIdx})}" class="btn btn-default btn-sm">삭제</a>
								</td>
								<td th:unless="${c.mId==session.SID and c.cmtDeleteYn=='N'}" ></td>
								
								<td class="replyBtn"><button class="btn btn-defalut  btn-sm">답글</button></td>
							</tr>
							<tr>
								<td colspan="4">
									<div class="form-group">
										<textarea  class="form-control replyContents" placeholder="댓글을 작성해주세요."></textarea>
									</div>
								</td>
								<td>
									<button type="button" class="btn  btn-sm  btn-default regReplyCmt">등록</button>
								</td>
							</tr>
						</th:block>
						<th:block th:unless="${comments!=null and comments.size()>0}">
							<tr id="noComment"><td colspan="5">등록된 댓글이 없습니다.</td></tr>
						</th:block>
					</tbody>
				</table>
				<div>
					<th:block layout:fragment="paging">
                  			<nav th:replace="fragments/commentPagination :: pagination"></nav>
                  	</th:block>
				</div>
				<hr>
				<div class="form-group" style="float:center; margin-top:10px;">
					<div class="col-xs-10 col-xs-offset-1">
						<textarea id="inputContents" class="form-control " placeholder="댓글을 작성해주세요."></textarea>
					</div>
					<div class="col-xs-1">
						<button type="button" class="btn  btn-sm  btn-default " id="regCmt">등록</button>		
					</div>
				</div>
			</div>
		</div>
	</div>
        
	</th:block>
	<th:block layout:fragment="customScript">
		<script type="text/javascript">
			var link = document.referrer;
			console.log(link.indexOf("?"));
			if(link.indexOf("?")>0){
				link = link.substring(0,link.indexOf("?"));
			}
			console.log(link);
			$('#returnPage').attr('href',link);
			var linkArr = link.split('/');
			var link2 = ('/'+linkArr[linkArr.length-2]+'/'+linkArr[linkArr.length-1])
			var firstUrl = $('#firstUrl');
			var secondUrl = $('#secondUrl');
			var thirdUrl = $('#thirdUrl');
			var a = $('a');
			a.each(function(){
				if($(this).attr('href')==link2){
					$(this).parent().parent().parent().children().eq(0).addClass('active');
					$(this).parent().parent().css('display','block');
					$(this).parent().addClass('active');
					firstUrl.text($(this).parent().parent().parent().children().eq(0).text());
					secondUrl.text($(this).parent().text());
					secondUrl.attr('href',$(this).prop('href'));
					console.log('확인')
				}
			});
			if(firstUrl.text().trim()==''){
				link2 = ('/'+linkArr[linkArr.length-2]+'/qna');
				a.each(function(){
					if($(this).attr('href')==link2){
						$(this).parent().parent().parent().children().eq(0).addClass('active');
						$(this).parent().parent().css('display','block');
						$(this).parent().addClass('active');
						firstUrl.text($(this).parent().parent().parent().children().eq(0).text());
						secondUrl.text($(this).parent().text());
						secondUrl.attr('href',$(this).prop('href'));
						console.log('확인')
					}
				});
			}
			var returnBtn=$('#returnBtn');
			var url = $('#url');
			url.val(link2);
			returnBtn.click(function(){
				location.href = link2;
			});
		</script>
		
		<script th:inline="javascript">
		$('#regCmt').click(function(){
			//댓글등록
			$.ajax({
				url : '/ajax/addCmt',
				type : 'post',
				data : {boardIdx : $('#bIdx').text() , comment : $('#inputContents').val(), boardId : $('#bId').text()},
				success : function(data){
					location.reload();
				}
				
			})
		})
		
		var idx = $('#bIdx').text();
		function movePage(uri, queryString) {
				location.href = uri+ queryString+'&idx='+idx;
			}
		
		$(document).ready(function(){
			
			var cmt = /*[[${comments}]]*/
			//모든 행 숨기기
			$('#commentTable tr').hide();
			//replyBtn 클래스를 가진 td의 tr 보이기
			$('#commentTable').find('.replyBtn').parent().show();
			$('#noComment').show();
			$(document).ready(function(){
				//모든 행 숨기기
				$('#commentTable tr').hide();
				//replyBtn 클래스를 가진 td의 tr 보이기
				$('#commentTable').find('.replyBtn').parent().show();
				$('#noComment').show();	
					
					$('.replyBtn').click(function(){
						var i = $('.replyBtn').index($(this));
						console.log(i)
						$('#commentTable tr').hide();
						$('#commentTable').find('.replyBtn').parent().show();
						
						//모든 tr들 담기
						var tr = $('#commentTable tr');
						//tr들의 인덱스 가져오기
						var index = $('#commentTable tr').index($('.replyBtn').eq(i).parent());
						
						
						for(var j = index ; j<index+2; j++){
							$(tr[j]).show();
						}
						
						$('.regReplyCmt').eq(i).click(function(){
							//대댓글등록시작
							$.ajax({
								url : '/ajax/addReCmt',
								type : 'post',
								data : {cmtIdx : $('.cmtIdx').eq(i).text(), 
										boardIdx : $('#bIdx').text(), 
										boardId : $('#bId').text(),
										comment : $('.replyContents').eq(i).val(),
										targetId : cmt[i].mId
										},
								success : function(data){
									location.reload();
								}
							});
						});
					});
					var qnamodifyBtn = $('#qnamodifyBtn');
					var bSubject1 = $('#bSubject1');
					var bSubject2 = $('#bSubject2');
					var bContents1 = $('#bContents1');
					var bContents2 = $('#bContents2');
					//게시글 수정
					qnamodifyBtn.click(function(){
						console.log('수정')
						if($(this).attr('data-attr')==0){
							bSubject1.css('display','none');
							bSubject2.css('display','block');
							bContents1.css('display','none');
							bContents2.css('display','block');
							$(this).text('수정완료');
							$(this).attr('data-attr',1);
						}else if($(this).attr('data-attr')==1){
							$.ajax({
								url : '/ajax/modifyQna',
								type : 'post',
								data : {bSubject : bSubject2.val(),bContents : bContents2.val(), bIdx : $('#bIdx').text()},
								success : function(data){
									console.log(data);
									qnamodifyBtn.text('수정');
									qnamodifyBtn.attr('data-attr',0);
									location.reload();
								}
							});
						}
							
						
					})
					
					//대댓글수정
					$('.modifyBtn').click(function(){
						
						
						var i = $('.modifyBtn').index($(this));
					
						var comment = $('.cmtComment').eq(i).text();
						if($(this).attr('data-attr')=='0'){
							$('.cmtComment').eq(i).html('<input type="text" value="'+cmt[i].cmtComment+'" id="cmtComment">');
							$(this).text('수정완료');
							$(this).attr('data-attr',1);
						}else{
							console.log($('#cmtComment').val());
							$.ajax({
								url : '/ajax/modifyCmt',
								type : 'post',
								data : {cmtIdx : $('.cmtIdx').eq(i).text(), comment : $('#cmtComment').val()},
								success : function(data){
									console.log(data);
									$('.modifyBtn').attr('data-attr',0);
									$('.modifyBtn').text('수정');
									
									location.reload();
									
								}
							})
						}
	
					});	
					
				});
	});	
	
	
			
			
		</script>
		<script src="/lib/fancybox/jquery.fancybox.js"></script>
		<script class="include" type="text/javascript" src="/lib/jquery.dcjqaccordion.2.7.js"></script>
		<!--common script for all pages-->
		<script type="text/javascript">
		    $(function() {
		      //    fancybox
		      jQuery(".fancybox").fancybox();
		    });
		</script>
		
	</th:block>
</html>