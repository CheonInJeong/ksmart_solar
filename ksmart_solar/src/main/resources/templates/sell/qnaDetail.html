<!DOCTYPE html>
<html xmlns:th="http://www.tyhmeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="layout/default">

	<th:block layout:fragment="customTitle">
				<title>판매관리>문의글</title>
	</th:block>
	<th:block layout:fragment="Contents">
		<div id="container-header-title"><strong>문의글</strong></div>
		<div id="container-header-path">
			<a href="/" style="text-decoration: none;"> 메인화면 </a>>
			<a href="#" id="firstUrl" style="text-decoration: none;"> </a>>
			<a href="#" id="secondUrl" style="text-decoration: none;"> </a>>
			<a href="#" id="thirdUrl" style="text-decoration: none;"> 문의글 </a>
		</div>
		<div id="container-header-space"></div>
		<div class="row">
			<div class="col-md-12">
				<div class="content-panel" style="padding : 30px 30px 100px 30px;">
				<h4><i class="fa fa-angle-right"></i>문의글</h4>
				<hr>
				
				<div id="bIdx" style="display:none">[[${qna.bIdx}]]</div>
				<div id="bId" style="display:none">[[${qna.mIdBuyer}]]</div>
				<table class="table" id="qnaTable">
					<tbody>
						<tr>
							<td>글제목</td>         			
							<td style="text-align:left" colspan="5" th:text="${qna.bSubject}"></td>               			
						</tr>
						<tr>
							<td>작성자</td>
							<td th:text="${qna.mIdBuyer}"></td>
							<td>작성시간</td>
							<td th:text="${qna.bRegDate}"></td>
							<td>조회수</td>
							<td th:text="${qna.bView}"></td>
						</tr>
						<tr>
							<td style="text-align:left;padding-left:60px;" colspan="6" th:text="${qna.bContents}"></td>
						<tr>
					</tbody>
				</table>
				<hr>
				
				
				<div style="margin-top :40x;width:100%;">
						<a class="btn btn-default pull-right" th:href="@{/sell/bidPlantDetail(bPlCode=${qna.announcedCode})}">이전</a>
				</div>
				<br>
				<div>
					<h4><i class="fa fa-angle-right"></i>댓글</h4>
				</div>
				<table class="table" id="commentTable">
					<tbody>
					
						<th:block th:if="${comments!=null and comments.size()>0}" th:each="c:${comments}">
							<tr>
								<td th:text="${c.cmtIdx}" class="cmtIdx" style="display:none"></td>
								<td th:if="${c.cmtClass==0}" th:text="${c.mId}"></td>
								<td th:if="${c.cmtClass>0}" th:text="${'└ '+c.mId}" style="padding-left:30px"></td>
								<td th:if="${c.cmtClass==0}" th:text="${c.cmtComment}" style="padding:20px; text-align:left;" class="cmtComment"></td>
								<td th:if="${c.cmtClass>0}" th:text="${c.targetId + '｜'+c.cmtComment}" style="padding:20px; text-align:left;" class="cmtComment"></td>
								<td th:text="${c.cmtRegDate}"></td>
								<td class="replyBtn"><button class="btn btn-defalut  btn-sm">답글</button></td>
								<td th:if="${c.mId==session.SID}">
									<a class="btn btn-default btn-sm modifyBtn" data-attr="0">수정</a>
									<a th:href="@{/sell/removeCmt(idx=${c.cmtIdx},bIdx=${c.bIdx})}" class="btn btn-default btn-sm">삭제</a></td>
							</tr>
							<tr>
								<td colspan="3">
									<div class="form=group">
										<textarea  class="form-control replyContents" placeholder="댓글을 작성해주세요."></textarea>
									</div>
								</td>
								<td><button type="button" class="btn  btn-sm  btn-default regReplyCmt">등록</button></td>
							</tr>
						</th:block>
						<th:block th:unless="${comments!=null and comments.size()>0}">
							<tr id="noComment"><td colspan="5">등록된 댓글이 없습니다.</td></tr>
						</th:block>
					</tbody>
				</table>
				<div>
					<th:block layout:fragment="paging">
                  			<nav th:replace="fragments/commentPagination :: pagination"></nav>
                  	</th:block>
				</div>
				<hr>
				<div class="form-group" style="float:center; margin-top:10px;">
					<div class="col-xs-10 col-xs-offset-1">
						<textarea id="inputContents" class="form-control " placeholder="댓글을 작성해주세요."></textarea>
					</div>
					<div class="col-xs-1">
						<button type="button" class="btn  btn-sm  btn-default " id="regCmt">등록</button>		
					</div>
				</div>
			</div>
		</div>
	</div>
        
	</th:block>
	<th:block layout:fragment="customScript">
		<script type="text/javascript">
			var link = document.referrer;
			console.log(link.indexOf("?"));
			if(link.indexOf("?")>0){
				link = link.substring(0,link.indexOf("?"));
			}
			console.log(link);
			$('#returnPage').attr('href',link);
			var linkArr = link.split('/');
			var link2 = ('/'+linkArr[linkArr.length-2]+'/'+linkArr[linkArr.length-1])
			var firstUrl = $('#firstUrl');
			var secondUrl = $('#secondUrl');
			var thirdUrl = $('#thirdUrl');
			var a = $('a');
			a.each(function(){
				if($(this).attr('href')==link2){
					$(this).parent().parent().parent().children().eq(0).addClass('active');
					$(this).parent().parent().css('display','block');
					$(this).parent().addClass('active');
					firstUrl.text($(this).parent().parent().parent().children().eq(0).text());
					secondUrl.text($(this).parent().text());
					secondUrl.attr('href',$(this).prop('href'));
					console.log('확인')
				}
			});
			if(firstUrl.text().trim()==''){
				link2 = ('/'+linkArr[linkArr.length-2]+'/qna');
				a.each(function(){
					if($(this).attr('href')==link2){
						$(this).parent().parent().parent().children().eq(0).addClass('active');
						$(this).parent().parent().css('display','block');
						$(this).parent().addClass('active');
						firstUrl.text($(this).parent().parent().parent().children().eq(0).text());
						secondUrl.text($(this).parent().text());
						secondUrl.attr('href',$(this).prop('href'));
						console.log('확인')
					}
				});
			}
		</script>
		
		<script th:inline="javascript">
		$('#regCmt').click(function(){
			//댓글등록
			$.ajax({
				url : '/ajax/addCmt',
				type : 'post',
				data : {boardIdx : $('#bIdx').text() , comment : $('#inputContents').val(), boardId : $('#bId').text()},
				success : function(data){
					location.reload();
				}
				
			})
		})
		
		var idx = $('#bIdx').text();
		function movePage(uri, queryString) {
				location.href = uri+ queryString+'&idx='+idx;
			}
		
		$(document).ready(function(){
			
			var cmt = /*[[${comments}]]*/
			//모든 행 숨기기
			$('#commentTable tr').hide();
			//replyBtn 클래스를 가진 td의 tr 보이기
			$('#commentTable').find('.replyBtn').parent().show();
			$('#noComment').show();
			$(document).ready(function(){
				//모든 행 숨기기
				$('#commentTable tr').hide();
				//replyBtn 클래스를 가진 td의 tr 보이기
				$('#commentTable').find('.replyBtn').parent().show();
				$('#noComment').show();	
					
					$('.replyBtn').click(function(){
						var i = $('.replyBtn').index($(this));
						console.log(i)
						$('#commentTable tr').hide();
						$('#commentTable').find('.replyBtn').parent().show();
						
						//모든 tr들 담기
						var tr = $('#commentTable tr');
						//tr들의 인덱스 가져오기
						var index = $('#commentTable tr').index($('.replyBtn').eq(i).parent());
						
						
						for(var j = index ; j<index+2; j++){
							$(tr[j]).show();
						}
						
						$('.regReplyCmt').eq(i).click(function(){
							//대댓글등록시작
							$.ajax({
								url : '/ajax/addReCmt',
								type : 'post',
								data : {cmtIdx : $('.cmtIdx').eq(i).text(), 
										boardIdx : $('#bIdx').text(), 
										boardId : $('#bId').text(),
										comment : $('.replyContents').eq(i).val(),
										targetId : cmt[i].mId
										},
								success : function(data){
									location.reload();
								}
							});
						});
					});
						
					//대댓글수정
					$('.modifyBtn').click(function(){
						
						
						var i = $('.modifyBtn').index($(this));
					
						var comment = $('.cmtComment').eq(i).text();
						if($(this).attr('data-attr')=='0'){
							$('.cmtComment').eq(i).html('<input type="text" value="'+cmt[i].cmtComment+'" id="cmtComment">');
							$(this).text('수정완료');
							$(this).attr('data-attr',1);
						}else{
							console.log($('#cmtComment').val());
							$.ajax({
								url : '/ajax/modifyCmt',
								type : 'post',
								data : {cmtIdx : $('.cmtIdx').eq(i).text(), comment : $('#cmtComment').val()},
								success : function(data){
									console.log(data);
									$('.modifyBtn').attr('data-attr',0);
									$('.modifyBtn').text('수정');
									
									location.reload();
									
								}
							})
						}
	
					});	
					
				});
	});	
	
	
			
			
		</script>
		
		
	</th:block>
</html>