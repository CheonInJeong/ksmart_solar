
<!DOCTYPE html>
<html xmlns:th="http://www.tyhmeleaf.org">
<head>
		 <!-- Bootstrap core CSS -->
<link th:href="@{/lib/bootstrap/css/bootstrap.min.css}" rel="stylesheet">

  <link th:href="@{/lib/font-awesome/css/font-awesome.css}" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/zabuto_calendar.css}">
  <link rel="stylesheet" type="text/css" th:href="@{/lib/gritter/css/jquery.gritter.css}" />
<script th:src="@{/lib/jquery/jquery-3.5.1.min.js}"></script>

  
	<style>
		body{
		background-color :#eaeaea; }
	</style>

</head>
<body>

		<div id="bIdx" style="display:none">[[${qna.bIdx}]]</div>
		<div id="bId" style="display:none">[[${qna.mIdBuyer}]]</div>
			<div style="padding:30px;">
			
					<div class="row">
						<div class="col-md-12">
				<div>
					<h4><i class="fa fa-angle-right"></i>댓글</h4>
				</div>
				<table class="table table-striped" id="commentTable">
					<tbody>
						<th:block th:if="${comments!=null and comments.size()>0}" th:each="c:${comments}">
							<tr>
									<td th:text="${c.cmtIdx}" class="cmtIdx" style="display:none"></td>
									<td th:if="${c.cmtClass==0}" th:text="${c.mId}" style="font-weight: bolder"></td>
									<td th:if="${c.cmtClass>0}" th:text="${'└ '+c.mId}" style="padding-left:30px;font-weight: bolder"></td>
									<td th:if="${c.cmtClass==0 and c.cmtDeleteYn=='N'}" th:text="${c.cmtComment}" style="padding:20px; text-align:left;" class="cmtComment"></td>
									<td th:if="${c.cmtClass>0 and c.cmtDeleteYn=='N'}" th:text="${c.targetId + '｜'+c.cmtComment}" style="padding:20px; text-align:left;" class="cmtComment"></td>
									<td th:if="${c.cmtClass==0 and c.cmtDeleteYn=='Y'}" style="padding:20px; text-align:left;" class="cmtComment">삭제 된 댓글입니다.</td>
									<td th:if="${c.cmtClass>0 and c.cmtDeleteYn=='Y' }" th:text="${c.targetId + '｜'+'삭제 된 댓글입니다.'}" style="padding:20px; text-align:left;" class="cmtComment"></td>
									<td th:text="${c.cmtRegDate}"></td>
									<td th:if="${c.mId!=session.SID}">
											<a class="btn btn-default btn-sm modifyBtn" data-attr="0" style="display:none">수정</a>
											<a class="btn btn-default btn-sm deleteBtn" style="display:none">삭제</a>
									</td>
									<td th:if="${c.mId==session.SID}">
										<th:block th:if="${c.cmtDeleteYn=='Y'}">
											<a class="btn btn-default btn-sm modifyBtn" data-attr="0" style="display:none">수정</a>
											<a class="btn btn-default btn-sm deleteBtn" style="display:none">삭제</a>
										</th:block>
										<th:block th:if="${c.cmtDeleteYn=='N'}">
											<a class="btn btn-default btn-sm modifyBtn" data-attr="0">수정</a>
											<a class="btn btn-default btn-sm deleteBtn">삭제</a>
										</th:block>
									</td>
									
									<td class="replyBtn"><button class="btn btn-defalut  btn-sm">답글</button></td>
							</tr>
							<tr>
								<td colspan="4">
									<div class="form-group">
										<textarea  class="form-control replyContents" placeholder="댓글을 작성해주세요."></textarea>
									</div>
								</td>
								<td>
									<button type="button" class="btn  btn-sm  btn-default regReplyCmt">등록</button>
								</td>
							</tr>
						</th:block>
						<th:block th:unless="${comments!=null and comments.size()>0}">
							<tr id="noComment"><td colspan="5">등록된 댓글이 없습니다.</td></tr>
						</th:block>
					<tfoot>
						<tr id="paging">
							<td colspan="5">
								<nav th:fragment="pagination" th:if="${commentDTO != null and commentDTO.pagination?.totalRecordCount > 0}" th:object="${commentDTO.pagination}" th:with="info=${commentDTO.pagination}" aria-label="Page navigation" class="text-center">
									<ul class="pagination">
										<li th:if="*{hasPreviousPage == true}" th:onclick="movePage([[ ${#request.requestURI} ]], [[ ${commentDTO.makeQueryString(1)} ]])">
											<a href="javascript:void(0)" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
										</li>
										<li th:if="*{hasPreviousPage == true}" th:onclick="movePage([[ ${#request.requestURI} ]], [[ ${commentDTO.makeQueryString(info.firstPage - 1)} ]])">
											<a href="javascript:void(0)" aria-label="Previous"><span aria-hidden="true">&lsaquo;</span></a>
										</li>
										<li th:each="pageNo : *{#numbers.sequence( firstPage, lastPage )}" th:class="${pageNo == commentDTO.currentPageNo} ? 'active'">
											<a href="javascript:void(0)" th:text="${pageNo}" th:onclick="movePage([[ ${#request.requestURI} ]], [[ ${commentDTO.makeQueryString(pageNo)} ]])"></a>
										</li>
										<li th:if="*{hasNextPage == true}" th:onclick="movePage([[ ${#request.requestURI} ]], [[ ${commentDTO.makeQueryString(info.lastPage + 1)} ]])">
											<a href="javascript:void(0)" aria-label="Next"><span aria-hidden="true">&rsaquo;</span></a>
										</li>
										<li th:if="*{hasNextPage == true}" th:onclick="movePage([[ ${#request.requestURI} ]], [[ ${commentDTO.makeQueryString(info.totalPageCount)} ]])">
											<a href="javascript:void(0)" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
										</li>
									</ul>
								</nav>
							</td>
						</tr>
					</tbody>
				</table>
				
				<hr>
				<div class="form-group" style="float:center; margin-top:10px;">
					<div class="col-xs-10 col-xs-offset-1">
						<textarea id="inputContents" class="form-control " placeholder="댓글을 작성해주세요."></textarea>
					</div>
					<div class="col-xs-1">
						<button type="button" class="btn  btn-sm  btn-default " id="regCmt">등록</button>		
					</div>
				</div>
			</div>
		</div>
</div>
	
	<script th:inline="javascript">
	
		function movePage(uri, queryString) {
			location.href = uri+ queryString+'&bIdx='+$('#bIdx').text();
		}

			$(document).ready(function(){
			
				
				$('#regCmt').click(function(){
					//댓글등록
					$.ajax({
						url : '/ajax/addCmt',
						type : 'post',
						data : {boardIdx : $('#bIdx').text() , comment : $('#inputContents').val(), boardId : $('#bId').text()},
						success : function(data){
							location.reload();
						}
						
					})
				});
				
				$('.deleteBtn').click(function(){
					var i = $('.deleteBtn').index(this);
					console.log($('.cmtIdx').eq(i).text());
					console.log($('.cmtComment').eq(i).text());
					$.ajax({
						url : '/ajax/deleteCmt',
						type: 'post',
						data : {idx:$('.cmtIdx').eq(i).text(), bIdx: $('#bIdx').text()},
						success : function(data){
							location.reload();
						}
							
					})
				});
				
				var idx = $('#bIdx').text();
			
			var cmt = /*[[${comments}]]*/
			//모든 행 숨기기
			$('#commentTable tr').hide();
			//replyBtn 클래스를 가진 td의 tr 보이기
			$('#commentTable').find('.replyBtn').parent().show();
			$('#noComment').show();
			
			$(document).ready(function(){
				//모든 행 숨기기
				$('#commentTable tr').hide();
				//replyBtn 클래스를 가진 td의 tr 보이기
				$('#paging').show();
				$('#commentTable').find('.replyBtn').parent().show();
				$('#noComment').show();	
					
					$('.replyBtn').click(function(){
						var i = $('.replyBtn').index($(this));
						console.log(i)
						$('#commentTable tr').hide();
						$('#commentTable').find('.replyBtn').parent().show();
						
						//모든 tr들 담기
						var tr = $('#commentTable tr');
						//tr들의 인덱스 가져오기
						var index = $('#commentTable tr').index($('.replyBtn').eq(i).parent());
						
						
						for(var j = index ; j<index+2; j++){
							$(tr[j]).show();
						}
						
						$('.regReplyCmt').eq(i).click(function(){
							//대댓글등록시작
							$.ajax({
								url : '/ajax/addReCmt',
								type : 'post',
								data : {cmtIdx : $('.cmtIdx').eq(i).text(), 
										boardIdx : $('#bIdx').text(), 
										boardId : $('#bId').text(),
										comment : $('.replyContents').eq(i).val(),
										targetId : cmt[i].mId
										},
								success : function(data){
									location.reload();
								}
							});
						});
					});
					var qnamodifyBtn = $('#qnamodifyBtn');
					var bSubject1 = $('#bSubject1');
					var bSubject2 = $('#bSubject2');
					var bContents1 = $('#bContents1');
					var bContents2 = $('#bContents2');
					//게시글 수정
					qnamodifyBtn.click(function(){
						console.log('수정')
						if($(this).attr('data-attr')==0){
							bSubject1.css('display','none');
							bSubject2.css('display','block');
							bContents1.css('display','none');
							bContents2.css('display','block');
							$(this).text('수정완료');
							$(this).attr('data-attr',1);
						}else if($(this).attr('data-attr')==1){
							$.ajax({
								url : '/ajax/modifyQna',
								type : 'post',
								data : {bSubject : bSubject2.val(),bContents : bContents2.val(), bIdx : $('#bIdx').text()},
								success : function(data){
									console.log(data);
									qnamodifyBtn.text('수정');
									qnamodifyBtn.attr('data-attr',0);
									location.reload();
								}
							});
						}
							
						
					})
					
					//대댓글수정
					$('.modifyBtn').click(function(){
						
						var i = $('.modifyBtn').index($(this));
					
						var comment = $('.cmtComment').eq(i).text();
						if($(this).attr('data-attr')=='0'){
							$('.cmtComment').eq(i).html('<input type="text" value="'+cmt[i].cmtComment+'" id="cmtComment">');
							$(this).text('수정완료');
							$(this).attr('data-attr',1);
						}else{
							console.log($('#cmtComment').val());
							$.ajax({
								url : '/ajax/modifyCmt',
								type : 'post',
								data : {cmtIdx : $('.cmtIdx').eq(i).text(), comment : $('#cmtComment').val()},
								success : function(data){
									console.log(data);
									$('.modifyBtn').attr('data-attr',0);
									$('.modifyBtn').text('수정');
									
									location.reload();
								}
							})
						}
	
					});	
					
				});
	});	
	
			
		</script>
</body>
	
</html>