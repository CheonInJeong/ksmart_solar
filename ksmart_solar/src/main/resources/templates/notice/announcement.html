<!DOCTYPE html>
<html xmlns:th="http://www.tyhmeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="@{layout/default}">

	<th:block layout:fragment="customTitle">
				<title>공고정보</title>
	</th:block>
	<th:block layout:fragment="Contents">
		<div id="container-header-title"><strong>공고정보</strong></div>
		<div id="container-header-path">
			<a href="#" id="firstUrl" style="text-decoration: none;"> </a>>
			<a href="#" id="secondUrl" style="text-decoration: none;"> </a>>
			<a href="#" id="thirdUrl" style="text-decoration: none;"> 공고정보 </a>
		</div>
		<div id="container-header-space"></div>
		<input type="hidden" id="bCpReCount" 	th:if="${bidComponentdto!=null}"	th:value="${bidComponentdto.bCpReCount}">
		<input type="hidden" id="bCpGroupcode" 	th:if="${bidComponentdto!=null}"	th:value="${bidComponentdto.bCpGroupcode}">
		<input type="hidden" id="bPlReCount" 	th:if="${bidPlantdto!=null}" 		th:value="${bidPlantdto.bPlReCount}">
		<input type="hidden" id="bPlGroupcode" 	th:if="${bidPlantdto!=null}"		th:value="${bidPlantdto.bPlGroupcode}">
		<form id="bidComponentForm" action="/notice/bidRequest" method="post">
			<div class="chat-room mt" th:if="${bidComponentdto!=null}" >
				<input type="hidden" name="announcedCode" 	th:value="${bidComponentdto.bCpCode}">
				<input type="hidden" name="announcedTitle" 	th:value="${bidComponentdto.bCpTitle}">
				<input type="hidden" name="announcedPrice" 	th:value="${bidComponentdto.bCpPrice}">
				<input type="hidden" name="announcedType" 	th:value="${2}">
				<input type="hidden" name="url">
	          	<aside class="mid-side container" >
		            <div class="chat-room-head">
		              <h3>부품 공고</h3>
		            </div>
		            <div class="group-rom">
		              <div class="first-part odd">공고 제목</div>
		              <div class="second-part" th:text="${bidComponentdto.bCpTitle}"></div>
		            </div>
		            <div class="group-rom">
		              <div class="first-part odd">재공고 여부</div>
		              <div class="second-part" th:if="${bidComponentdto.bCpReCount==0}">신규</div>
		              <div class="second-part" th:if="${bidComponentdto.bCpReCount>0}">재공고</div>
		            </div>
		        	<div class="group-rom">
				       <div class="first-part odd" style="width: 25%; height: 200px; padding-top:90px;">공고 내용</div>
			           <div class="second-part" style="width: 75%; height: 200px;">
				        	<div style="width:100%; height:100%; object-fit:contain !important; overflow: scroll;" 
				        	th:text="${bidComponentdto.bCpContents}"></div>
			           </div>
		          	</div>
		            <div class="group-rom">
		              <div class="first-part odd">입찰 시작가</div>
		              <div class="second-part price" th:text="${bidComponentdto.bCpPrice+'원'}"></div>
		            </div>
		            <div class="group-rom">
		              <div class="first-part odd">부품 사용 시작일</div>
		              <div class="second-part" th:text="${bidComponentdto.cpUsedate}"></div>
		            </div>
		            <div class="group-rom">
		              <div class="first-part odd">입찰 신청기간</div>
		              <div class="second-part" th:text="${bidComponentdto.bCpDateBidding1+'   ~   '+bidComponentdto.bCpDateBidding2}"></div>
		            </div>
		            <div class="group-rom">
		              <div class="first-part odd">낙찰자 결정 기간</div>
		              <div class="second-part" th:text="${bidComponentdto.bCpDateDecision1+'   ~   '+bidComponentdto.bCpDateDecision2}"></div>
		            </div>
		            <div class="group-rom">
		              <div class="first-part odd">진행 상태</div>
		              <div class="second-part" th:text="${bidComponentdto.bCpStatus}"></div>
		            </div>
		       </aside>
            </div>
    	</form>
        
        <form id="bidPlantForm" action="/notice/bidRequest" method="post">
			<div class="chat-room mt" th:if="${bidPlantdto!=null}">
				<input type="hidden" name="announcedCode" th:value="${bidPlantdto.bPlCode}">
				<input type="hidden" name="announcedTitle" th:value="${bidPlantdto.bPlTitle}">
				<input type="hidden" name="announcedPrice" th:value="${bidPlantdto.bPlPrice}">
				<input type="hidden" name="announcedType" th:value="${1}">
				<input type="hidden" name="url">
	          <aside class="mid-side container">
	            <div class="chat-room-head">
	              <h3>발전소 공고</h3>
	            </div>
	             <div class="group-rom">
	              <div class="first-part odd">공고 제목</div>
	              <div class="second-part" th:text="${bidPlantdto.bPlTitle}"></div>
	            </div>
	             <div class="group-rom">
	              <div class="first-part odd">재공고 여부</div>
	              <div class="second-part" th:if="${bidPlantdto.bPlReCount==0}">신규</div>
	              <div class="second-part" th:if="${bidPlantdto.bPlReCount>0}">재공고</div>
	            </div>
	            <div class="group-rom">
			       <div class="first-part odd" style="width: 25%; height: 200px; padding-top:90px;">공고 내용</div>
		           <div class="second-part" style="width: 75%; height: 200px;">
			        	<div style="width:100%; height:100%; object-fit:contain !important; overflow: scroll;" 
			        	th:text="${bidPlantdto.bPlContents}"></div>
		           </div>
	          	</div>
	            <div class="group-rom">
	              <div class="first-part odd">입찰 시작가</div>
	              <div class="second-part price" th:text="${bidPlantdto.bPlPrice+'원'}"></div>
	            </div>
	            <div class="group-rom">
	              <div class="first-part odd">잔존 가치</div>
	              <div class="second-part price" th:text="${bidPlantdto.plDepDataResidual+'원'}"></div>
	            </div>
	            <div class="group-rom">
	              <div class="first-part odd">입찰 신청기간</div>
	              <div class="second-part" th:text="${bidPlantdto.bPlDateBidding1+'   ~   '+bidPlantdto.bPlDateBidding2}"></div>
	            </div>
	            <div class="group-rom">
	              <div class="first-part odd">낙찰자 결정 기간</div>
	              <div class="second-part" th:text="${bidPlantdto.bPlDateDecision1+'   ~   '+bidPlantdto.bPlDateDecision2}"></div>
	            </div>
	            <div class="group-rom">
	              <div class="first-part odd">진행 상태</div>
	              <div class="second-part" th:text="${bidPlantdto.bPlStatus}"></div>
	            </div>
	          </aside>
	        </div>
        </form>
        <div th:include="notice/plantInfo :: plantInfoFragment" 
        	 th:if="${bidPlantdto!=null and businessPlantDTO!=null}"></div>
        <div th:include="notice/componentInfo :: componentInfoFragment" 
        	 th:if="${bidComponentdto!=null}"></div>
        <div th:include="notice/bidResult :: bidResultFragment" 
        	 th:if="${(bidListDTO != null and bidListDTO.trTypeCode>=1 and bidListDTO.trTypeCode<=10) 
        	 		or (bidListDTO != null and bidListDTO.trTypeCode==15)}"></div>
        <div th:include="notice/paymentInResult :: paymentInResultFragment" 
        	 th:if="${bidListDTO != null and tradePaymentInDTO!=null and bidListDTO.trTypeCode>=11 and bidListDTO.trTypeCode<=14}"></div>
		<div class="row" style="margin: 5px 0px;">
			<div class="form-inline" style="text-align: center;">
				<div class="form-group" th:if="${(bidComponentdto != null and bidComponentdto.acStatusCode==4 and getBidListCount==0)
													or (bidComponentdto != null and bidListDTO != null and bidListDTO.trTypeCode==4)}">
			 		<button id="bidComponentBtn" class="btn btn-default">입찰신청</button>
				</div>
				
				<div class="form-group" th:if="${(bidPlantdto != null and bidPlantdto.acStatusCode==4 and getBidListCount==0)
													or (bidPlantdto != null and bidListDTO != null and bidListDTO.trTypeCode==4)}">
			 		<button id="bidPlantBtn" class="btn btn-default">입찰신청</button>
				</div>
				<form class="form-group" action="/notice/bidCancel" method="post">
					<div class="form-group" th:if="${bidListDTO != null and bidListDTO.trTypeCode==3}">
						<input type="hidden" name="bCode" th:value="${bidListDTO.bCode}">
				 		<button type="submit" class="btn btn-default">입찰취소</button>
					</div>
				</form>
				<form class="form-group" action="/notice/paymentInRequest" method="post">
					<div th:if="${bidListDTO != null and bidListDTO.trTypeCode==11 and tradePaymentInDTO.mAccountBankName==null}">
						<input type="hidden" name="bCode" th:value="${bidListDTO.bCode}">
						<input type="hidden" name="url">					
				 		<button id="paymantIn" type="submit" class="btn btn-default">대금 납부</button>
					</div>
				</form>
				<form class="form-group" action="/notice/modifyPaymentIn" method="post">
					<div th:if="${bidListDTO != null and bidListDTO.trTypeCode==11 and tradePaymentInDTO.mAccountBankName!=null}">
						<input type="hidden" name="bCode" th:value="${bidListDTO.bCode}">
						<input type="hidden" name="url">					
				 		<button type="submit" class="btn btn-default">대금 납부 수정</button>
					</div>
				</form>
				
				<div class="form-group" th:if="${bidListDTO != null and bidListDTO.trTypeCode == 6}">
			 		<button class="btn btn-default">계약 취소</button>
				</div>
				
	        	<a class="form-group" id="returnPage">
		        	<button class="btn btn-default center-block" type="button" >돌아가기</button>
	        	</a>
	        	<!--찜하기  -->
	        	<form class="form-group" action="/mypage/addWishlist" method="post">
					<input th:if="${bidComponentdto != null}" type="hidden" name="announcedCode" th:value="${bidComponentdto.bCpCode}">	        	
					<input th:if="${bidPlantdto != null}" type="hidden" name="announcedCode" th:value="${bidPlantdto.bPlCode}">					
		        	<button class="btn btn-warning center-block" type="submit" >찜하기</button>
	        	</form>

			</div>
		</div>
	</th:block>
	
	<th:block layout:fragment="customScript">
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
		<script type="text/javascript">
			var link = document.referrer;
			$('#returnPage').attr('href',link);
			var linkArr = link.split('/');
			var link2 = ('/'+linkArr[linkArr.length-2]+'/'+linkArr[linkArr.length-1])
			var firstUrl = $('#firstUrl');
			var secondUrl = $('#secondUrl');
			var thirdUrl = $('#thirdUrl');
			var a = $('a');
			a.each(function(){
				if($(this).attr('href')==link2){
					$(this).parent().parent().parent().children().eq(0).addClass('active');
					$(this).parent().parent().css('display','block');
					$(this).parent().addClass('active');
					firstUrl.text($(this).parent().parent().parent().children().eq(0).text());
					secondUrl.text($(this).parent().text());
					secondUrl.attr('href',$(this).prop('href'));
				}
			});
			var url = $('[name="url"]')
			url.val(link2);
			$(function(){
				var price = $('.price');
				price.each(function(){
					$(this).text($(this).text().toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','));
				})
			})
			var bCpReCount = $('#bCpReCount');
			var bPlReCount = $('#bPlReCount');
			var bCpGroupcode = $('#bCpGroupcode');
			var bPlGroupcode = $('#bPlGroupcode');
			$('#bidComponentBtn').click(function(){
				if(!bidReCount(bCpReCount,bCpGroupcode)){
					return false;
				}
				$('#bidComponentForm').submit();
			});
			$('#bidPlantBtn').click(function(){
				if(!bidReCount(bPlReCount,bPlGroupcode)){
					return false;
				}
				$('#bidPlantForm').submit();
			});
			
			function bidReCount (ReCount,bGroupcode){
				var result = true;
				if(ReCount.val()>0){
					var count = 0;
					$.ajax({
						  url: '/reBidCount', 
						  method: 'get',
						  data : {bGroupcode : bGroupcode.val()},
						  async:false,
						  success: function(data){
							  if(data > 0){
								  console.log(data);
								  count = data;
								  Swal.fire({
									  title: '입찰실패!',
									  text: '이전공고에서 계약취소 또는 대금 미납하셔서 입찰하실 수 없습니다.',
									  icon: 'error'
									});
							  }
						  },
						  error : function(xhr,status,error){
							  console.log("xhr: " + xhr);
							  console.log("status: " + status);
							  console.log("error: " + error);
						  }
					});
					console.log(count);
					if(count!=0){
						console.log('입찰못함')
						result = false;
					}
				}
				return result;
			}
		</script>
	</th:block>
</html>