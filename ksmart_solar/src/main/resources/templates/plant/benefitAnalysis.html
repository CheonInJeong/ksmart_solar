<!DOCTYPE html>
<html xmlns:th="http://www.tyhmeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="@{layout/default}">

	<th:block layout:fragment="customTitle">
		<title>수익분석</title>
	</th:block>
	<th:block layout:fragment="Contents">
		<div id="container-header-title"><strong>수익 분석</strong></div>
		<div id="container-header-path" style="color: black;">
			<a href="/" >메인화면 </a>>
			<a href="/plant/plantList" > 내 발전소 관리 </a>>
			<a href="/plant/plantList"> 발전소 리스트 </a>>
			<a href="/plant/plantDetail" > 발전소 상세정보 </a>>
			<a href="/plant/plantDetail/benefitAnalysis"> 수익 분석 </a>
		</div>
		<div id="container-header-space"></div>
		<div class="row mt col-xs-12" style="padding-bottom: 30px; margin:0 auto; color: #111; font-size: 15px; min-height: 80vh;">
			<div class="content-panel col-xs-12">
				<div th:if="${bzPlName ne null}" style="margin:20px 5% 20px 5%; width:90%;">
					<div>
						<div class="h1 col-md-6">
							<span style="font-weight:900; margin-right: 10px;">[[${bzPlName}]]</span>
							<button type="button" id="plantModify" th:data-plName="${bzPlName}" th:data-plCode="${plCode}" class="btn btn-info btn-xs">수정</button>
							<button type="button" id="plantDelete" th:data-plName="${bzPlName}" th:data-plCode="${plCode}" class="btn btn-danger btn-xs">삭제</button>
						</div>
						<div class="h2 col-md-6 col-xs-12" style="margin: 20px 0 15px 0; padding: 0;">
							<div class="col-xs-6">
								<input type="button" id="" class="standardBtn btn btn-md benefitAnalysis" value="수익 분석" style="width: 90%;">
							</div>
							<div class="col-xs-6">
								<input type="button" id="" class="standardBtn btn btn-md generationAnalysis" value="발전량 분석" style="width: 90%;">
							</div>
						</div>
					</div><br>
					<div class="col-lg-3 col-md-4 col-sm-6" style="margin: 40px 0 0 0;">
						<div class="h3" style="font-weight: 600;">기준금액</div>
						<p class="h3">[[${basedPrice}]] <small>[원]</small></p>
					</div>
					<div class="col-lg-3 col-md-4 col-sm-6" style="margin: 40px 0 0 0;">
						<div class="h3" style="font-weight: 600;">잔존가치</div>
						<p class="h3">[[${residualPrice}]] <small>[원]</small></p>
					</div>
					<div class="col-lg-3 col-md-4 col-sm-6" style="margin: 40px 0 0 0;">
						<div class="h3" style="font-weight: 600;">감가율</div>
						<p class="h3">[[${residualRate}]] <small>[%]</small></p>
					</div>
					<div class="col-lg-3 col-md-4 col-sm-6" style="margin: 40px 0 0 0;">
						<div class="h3" style="font-weight: 600;">경과기간</div>
						<p class="h3">[[${pastYear}]]<small>년</small> [[${pastMonth}]]<small>개월</small></p>
		            </div>
				<div class="col-xs-12" style="height: 5vh;"></div>
		        <div class="row">
		        <span style="float: right; color: #888;">
			        <small>수익 = 발전소 용량 x 월별 평균발전량 x 패널 수명 효율</small><br>
			        <small>비용 = 고정유지비 + 예상유지비(인버터교체비용등 )</small><br>
			        <small>손익 = 수익 - 비용</small>
		        </span>
					<canvas id="myChart" style="width: 100%;"></canvas>
				</div>
		        </div>
			</div>
		</div>
		<div hidden="" id="thymeleafData" th:data-bzPlPower="${bzPlPower}" th:data-smp="${smp}" th:data-rec="${rec}" th:data-basedPrice="${basedPrice2}" th:data-startDate="${startDate}"></div>
	</th:block>
	<th:block layout:fragment="customScript">
		<script src="/js/plant.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script type="text/javascript">
				var plantPower = $('#thymeleafData').attr('data-bzPlPower');
				var smp = $('#thymeleafData').attr('data-smp');
				var rec = $('#thymeleafData').attr('data-rec');
				var basedPrice = $('#thymeleafData').attr('data-basedPrice');
				var startDate = $('#thymeleafData').attr('data-startDate');
				///////////////감가 그래프 계산////////////////
				var labelsArray = []
				var residualPriceArray = [basedPrice];
				var residualRateArray = [0.007936508,0.007539683,0.007142857,0.006746032,0.006349206,0.005952381,0.005555556,0.00515873,0.004761905,0.004365079,0.003968254,0.003571429,0.003174603,0.002777778,0.002380952,0.001984127,0.001587302,0.001190476,0.000793651,0.000396825];
				var date = new Date(); 
				var todayYear = date.getFullYear(); 
				var todayMonth = new String(date.getMonth()+1); 
				var startYear = startDate.substring(0,4);
				var startMonth = startDate.substring(4,6);
				var calculMonth = startMonth;
				var basedRatePrice = basedPrice;
				if(todayMonth.length == 1){ 
					todayMonth = "0" + todayMonth; 
				}
				var nowDate = todayYear + '/' + todayMonth;
				for(var i=0; i<20; i++){
					for(var j=0; j<12; j++){
						basedPrice = basedPrice - (basedRatePrice * residualRateArray[i]);
						if(basedPrice > 0){
							residualPriceArray.push(Math.round(basedPrice));
						}
						
					}
				}
				for(var i=0; i<240; i++){
					if(startMonth < 12){
						if(startMonth < 10 && i != 0){ 
							startMonth = "0" + startMonth; 
						}
						labelsArray.push(startYear+'/'+startMonth);
						startMonth++;
					}else if(startMonth == 12){
						labelsArray.push(startYear+'/'+startMonth);
						startMonth = 1;
						startYear++;
					}
				}
				
				///////////////////// 수익, 비용, 손익 계산///////////////////////
				var benefitArray = [];	//수익 >> 현재 수익 * 월별 예상 발전량 * 연도별로 줄어드는 % (연간 1.5% 감소)
				var costArray = [];	//비용 >> 입력한 비용에 %를 곱하고 10년단위로 인버터 비용 추가, 연간 kw당 1.2만원, 인버터 비용 1번교체 1kw당 12만
				var incomeArray = [];	//손익 >> 수익 - 비용
				var incomeSumArray = []; //누적 손익
				//모듈 제조사 연도별 효율
				var efficiencyRate = [100.0, 99.2, 98.4, 97.6, 96.8, 96.1, 95.3, 94.5, 93.8, 93.0, 91.5, 90.8, 90.1, 89.4, 88.7, 87.9, 87.2, 86.5, 85.9, 85.1]
				//월별 발전시간(쏠라커넥트)
				var generationTime = [87.42,98.56,134.85,141.6,150.66,133.5,103.23,116.87,101.4,115.01,88.8,79.67]
				var count = 0;
				var benefitSum = 0;
				//인버터 가격, 월유지비 * 유지비는 증가
				
				
				
				for(var i=0; i<20; i++){
					for(var j=0; j<12; j++){
						var genPower = plantPower*efficiencyRate[i]*generationTime[j]/100;
						console.log(genPower);
						if(calculMonth == 12){
							benefitArray[count] = Math.round((genPower*smp) + (rec/1000 * genPower));
							calculMonth = 1;
						}else{
							benefitArray[count] = Math.round((genPower*smp) + (rec/1000 * genPower));
							calculMonth++;
						}
						benefitSum = benefitSum + Math.round((genPower*smp) + (rec/1000 * genPower));
						incomeSumArray[count] = benefitSum;
						count++;
					}
				}
				
				console.log(benefitArray);
				
				//수익 계산공식, 비용 계산공식 화면에 표시
				
				chartDraw();
				
				function chartDraw(){
					var ctx = document.getElementById('myChart').getContext('2d');
					var myChart = new Chart(ctx, {
					    type: 'bar',
					    data: {
					        datasets: [
					        	{
					        		label: '예상 수익', 
					        		data: benefitArray, 
					        		backgroundColor: 'rgb(255, 99, 132)', 
					        		borderColor: 'rgb(255, 99, 132)', 
					        		oreder: 0, 
					        		yAxisID: 'left'}
					        	,{
					        		label: '예상 비용', 
					        		data: costArray, 
					        		backgroundColor: 'rgb(255, 99, 132)', 
					        		borderColor: 'rgb(255, 99, 132)', 
					        		oreder: 1, 
					        		yAxisID: 'left'}
					        	,{
					        		label: '예상 손익', 
					        		data: incomeArray, 
					        		type: 'line',
					        		backgroundColor: '#465FC5', 
					        		borderColor: '#465FC5',
					        		fill: false, 
					        		order: 3, 
					        		yAxisID: 'left'
					        	}
					        	,{
					        		label: '누적 손익', 
					        		data: incomeSumArray, 
					        		type: 'line',
					        		backgroundColor: '#465FC5', 
					        		borderColor: '#465FC5',
					        		fill: false, 
					        		order: 4, 
					        		yAxisID: 'right'
					        	}
				        		,{
				        			label: '예상 잔존가치', 
				        			data: residualPriceArray,
				        			type: 'line',
				        			backgroundColor: '#DF7401', 
				        			borderColor: '#DF7401',
				        			order: 2, 
				        			yAxisID: 'right'
				        		}
					        ],
					        labels: labelsArray
					    },
					    options: {
					    	responsive: true,
					        interaction: {
					          mode: 'index',
					          intersect: false,
					        },
					        stacked: false,
					        plugins: {
					        },
					        scales: {
					          'left': {
					            type: 'linear',
					            position: 'left'
					          },
					          'right': {
					            type: 'linear',
					            position: 'right'
					          }
				            }
				        }
					});
				}
				
		</script>
	</th:block>
	
</html>